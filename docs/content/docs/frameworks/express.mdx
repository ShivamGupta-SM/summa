---
title: Express
description: Mount Summa's HTTP API on Express.
icon: Express
---

## Installation

```bash
pnpm add summa express
pnpm add -D @types/express
```

## Quick Start

```ts
import express from "express";
import { createSumma } from "summa";
import { createSummaExpress } from "summa/api/express";
import { drizzleAdapter } from "@summa/drizzle-adapter";
import { drizzle } from "drizzle-orm/node-postgres";

const db = drizzle(process.env.DATABASE_URL!);

const summa = createSumma({
  database: drizzleAdapter(db),
  currency: "USD",
});

const app = express();
app.use(express.json());
app.use("/api/ledger", createSummaExpress(summa));

app.listen(3000, () => console.log("Listening on :3000"));
```

<Callout type="warn" title="Body parser required">
  Express does not parse JSON bodies by default. You **must** add `express.json()` before mounting Summa — otherwise all POST/PUT/PATCH request bodies will be empty.
</Callout>

## How It Works

`createSummaExpress()` returns an Express middleware function that:

1. Reads `req.method`, `req.path`, and `req.body` from the Express request
2. Flattens `req.query` values (Express may parse arrays) to single strings
3. Flattens `req.headers` arrays to first values
4. Passes everything to Summa's universal `handleRequest()` router
5. Writes the response via `res.status().json()`

The path is extracted from `req.path`, which Express automatically strips the mount prefix from — so Summa receives `/accounts`, not `/api/ledger/accounts`.

## Handler Options

All framework integrations share the same options:

| Option | Type | Description |
|--------|------|-------------|
| `rateLimiter` | `RateLimiter` | Rate limiter instance (see [Rate Limiting](#rate-limiting)) |
| `rateLimitKeyExtractor` | `function` | Extract rate limit key from request (e.g., API key, IP). Default: `"global"` |
| `trustedOrigins` | `string[]` | CSRF protection — only allow mutating requests from these origins |
| `onRequest` | `function` | Request interceptor. Return an `ApiResponse` to short-circuit (e.g., 401). |
| `onResponse` | `function` | Response interceptor. Modify responses before sending. |

<Callout type="info" title="No basePath option">
  Express handles prefix routing via `app.use("/prefix", handler)` — the adapter receives the path with the prefix already stripped. No `basePath` option is needed.
</Callout>

## Authentication

Use the `onRequest` hook to add authentication:

```ts
const handler = createSummaExpress(summa, {
  onRequest: (req) => {
    const apiKey = req.headers?.["x-api-key"];
    if (!apiKey || !isValidApiKey(apiKey)) {
      return {
        status: 401,
        body: { error: { code: "UNAUTHORIZED", message: "Invalid API key" } },
      };
    }
    return req;
  },
});
```

You can also use standard Express middleware before the Summa handler:

```ts
app.use("/api/ledger", authMiddleware, createSummaExpress(summa));
```

**Execution order:** Express middleware → `onRequest` → CSRF check → rate limiting → plugin hooks → route handler → plugin hooks (reverse) → `onResponse`

## Rate Limiting

```ts
import { createSummaExpress } from "summa/api/express";
import { createRateLimiter, standardRateLimit } from "summa/api";

app.use(
  "/api/ledger",
  createSummaExpress(summa, {
    rateLimiter: createRateLimiter(standardRateLimit),
    rateLimitKeyExtractor: (req) => req.headers?.["x-api-key"] ?? "anonymous",
  }),
);
```

| Preset | Limit | Window |
|--------|:-----:|:------:|
| `standardRateLimit` | 100 | 60s |
| `strictRateLimit` | 20 | 60s |
| `lenientRateLimit` | 500 | 60s |
| `burstRateLimit` | 10 | 1s |

## CSRF Protection

```ts
app.use(
  "/api/ledger",
  createSummaExpress(summa, {
    trustedOrigins: ["https://app.example.com"],
  }),
);
```

## Body Size Limits

```ts
app.use("/api/ledger", express.json({ limit: "1mb" }), createSummaExpress(summa));
```

## Full Production Example

```ts
import express from "express";
import { createSumma } from "summa";
import { createSummaExpress } from "summa/api/express";
import { createRateLimiter, standardRateLimit } from "summa/api";
import { createPooledAdapter, RECOMMENDED_POOL_CONFIG } from "@summa/drizzle-adapter";
import { auditLog, reconciliation, velocityLimits } from "summa/plugins";
import { drizzle } from "drizzle-orm/node-postgres";
import { Pool } from "pg";

// Database
const pool = new Pool({
  ...RECOMMENDED_POOL_CONFIG,
  connectionString: process.env.DATABASE_URL,
});
const db = drizzle(pool);
const { adapter, close } = createPooledAdapter({ pool, drizzle: db });

// Summa
const summa = createSumma({
  database: adapter,
  currency: "USD",
  plugins: [auditLog(), reconciliation(), velocityLimits()],
});

// Express app
const app = express();

app.use(express.json({ limit: "1mb" }));

app.use(
  "/api/ledger",
  createSummaExpress(summa, {
    rateLimiter: createRateLimiter(standardRateLimit),
    rateLimitKeyExtractor: (req) => req.headers?.["x-api-key"] ?? "anonymous",
    trustedOrigins: [process.env.APP_ORIGIN!],
    onRequest: (req) => {
      const key = req.headers?.["x-api-key"];
      if (!key) {
        return { status: 401, body: { error: { code: "UNAUTHORIZED", message: "Missing API key" } } };
      }
      return req;
    },
  }),
);

// Start workers
await summa.workers.start();

// Graceful shutdown
const server = app.listen(3000, () => console.log("Listening on :3000"));

async function shutdown() {
  server.close();
  await summa.workers.stop();
  await close();
  process.exit(0);
}

process.on("SIGTERM", shutdown);
process.on("SIGINT", shutdown);
```

## Combining with Existing Express Apps

Summa mounts as standard Express middleware, so you can add it alongside your own routes:

```ts
const app = express();
app.use(express.json());

// Your own routes
app.get("/api/users", userController.list);
app.post("/api/users", userController.create);

// Summa ledger routes
app.use("/api/ledger", createSummaExpress(summa));

// Error handler
app.use((err, req, res, next) => {
  console.error(err);
  res.status(500).json({ error: "Internal Server Error" });
});
```
