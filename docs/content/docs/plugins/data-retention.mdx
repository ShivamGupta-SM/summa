---
title: Data Retention
description: Unified data retention policies for automated cleanup across all Summa tables.
icon: Clock
---

## Overview

The data retention plugin manages data lifecycle for plugin-owned tables. Core cleanup (idempotency keys, worker leases) is handled by core workers automatically. This plugin provides configurable retention policies for audit logs, velocity logs, and FX quotes.

## Setup

```ts
import { createSumma } from "@summa-ledger/summa";
import { dataRetention } from "@summa-ledger/summa/plugins";

const summa = createSumma({
  database: adapter,
  currency: "USD",
  plugins: [
    dataRetention({
      auditLogs: "7y",
      velocityLogs: "90d",
      fxQuotes: "30d",
    }),
  ],
});
```

<Callout type="info">
  Core-owned tables (idempotency keys, worker leases) are cleaned automatically by core workers. This plugin manages retention for plugin-owned tables only.
</Callout>

## Configuration

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `velocityLogs` | `string` | `"30d"` | Retention for velocity/rate-limit logs (always active) |
| `auditLogs` | `string` | — | Retention for audit log entries |
| `fxQuotes` | `string` | — | Retention for expired FX rate quotes |
| `interval` | `string` | `"6h"` | How often the cleanup worker runs |

Duration strings support: `"1h"`, `"24h"`, `"7d"`, `"30d"`, `"90d"`, `"365d"`, `"7y"`.

Only configured policies are enforced — if a retention period is not set, that table is not cleaned up by this plugin. The `velocityLogs` policy is always active with a default of `"30d"`.

## How It Works

A single background worker runs on the configured `interval` (default: every 6 hours) and executes DELETE queries for each configured retention policy:

```sql
DELETE FROM "summa"."rate_limit_log"
WHERE created_at < NOW() - INTERVAL '30 days'
```

The worker uses a distributed lease to prevent duplicate runs in multi-instance deployments.

## Retention Status

Query the current retention status via the API:

```bash
curl http://localhost:3000/api/ledger/retention/status
```

```json
{
  "policies": {
    "rate_limit_log": { "retention": "30d", "rowCount": 1523 },
    "audit_log": { "retention": "7y", "rowCount": 45230 }
  },
  "interval": "6h"
}
```

## Background Workers

| Worker | Interval | Lease | Description |
|--------|----------|:-----:|-------------|
| `data-retention-cleanup` | Configurable (default: 6h) | Yes | Runs all configured retention policies |

## API Endpoints

| Method | Path | Description |
|--------|------|-------------|
| `GET` | `/retention/status` | Current retention status with per-table row counts |

## Relationship to Core Workers & Outbox

This plugin only manages retention for **plugin-owned** tables. Other cleanup is handled by its respective owner:

| Table | Cleaned by | Not this plugin |
|-------|------------|:---:|
| `idempotency_key` | [Core worker](/docs/configuration#core-workers) (`core:idempotency-cleanup`) | Yes |
| `worker_lease` | [Core worker](/docs/configuration#core-workers) (`core:lease-cleanup`) | Yes |
| `hold` (expiry) | [Core worker](/docs/configuration#core-workers) (`core:hold-expiry`) | Yes |
| `outbox_event` | [Outbox plugin](/docs/plugins/outbox) (`outbox-cleanup`) | Yes |
| `rate_limit_log` | **This plugin** (always, default: 30d) | — |
| `audit_log` | **This plugin** (if `auditLogs` set) | — |
| `fx_rate_quote` | **This plugin** (if `fxQuotes` set) | — |

The principle: **if core writes to a table, core cleans it up**. This plugin handles the remaining plugin-owned tables.

```ts
plugins: [
  dataRetention({         // Data lifecycle for plugin tables
    auditLogs: "7y",
    velocityLogs: "30d",
  }),
]
```
