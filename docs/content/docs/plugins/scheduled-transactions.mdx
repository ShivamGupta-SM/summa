---
title: Scheduled Transactions
description: Schedule future and recurring transactions.
icon: CalendarDays
---

## Overview

The scheduled transactions plugin allows you to schedule transactions for future execution, supporting one-time scheduled payments and recurring patterns. It provides a typed creation API and a background worker that automatically executes due transactions.

## Setup

```ts
import { createSumma } from "@summa-ledger/summa";
import { scheduledTransactions } from "@summa-ledger/summa/plugins";

const summa = createSumma({
  database: adapter,
  currency: "USD",
  plugins: [scheduledTransactions()],
});
```

## Configuration

```ts
scheduledTransactions({
  maxRetries: 3,           // Max execution attempts (default: 3)
  batchSize: 100,          // Transactions processed per batch (default: 100)
  maxBatchesPerRun: 50,    // Max batches per worker run (default: 50)
})
```

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `maxRetries` | `number` | `3` | Maximum execution retry attempts with exponential backoff |
| `batchSize` | `number` | `100` | Transactions processed per worker batch |
| `maxBatchesPerRun` | `number` | `50` | Maximum batches processed per worker execution |

## Creating Scheduled Transactions

```ts
import { createScheduledTransaction } from "@summa-ledger/summa/plugins";

const ctx = await summa.$context;

// One-time scheduled transfer
const scheduled = await createScheduledTransaction(ctx, {
  sourceIdentifier: "user_123",
  destinationIdentifier: "landlord_456",
  amount: 1500_00,
  currency: "USD",
  scheduledFor: "2026-03-01T00:00:00Z",
  reference: "rent-march-2026",
});

console.log(scheduled.id);     // UUID
console.log(scheduled.status); // "scheduled"
```

Or via the HTTP API:

```bash
curl -X POST http://localhost:3000/api/ledger/scheduled-transactions \
  -H "Content-Type: application/json" \
  -d '{
    "sourceIdentifier": "user_123",
    "destinationIdentifier": "landlord_456",
    "amount": 150000,
    "currency": "USD",
    "scheduledFor": "2026-03-01T00:00:00Z",
    "reference": "rent-march-2026"
  }'
```

### Recurring Transactions

Pass `recurrence` to create a recurring schedule:

```ts
// Monthly rent — max 12 executions
const recurring = await createScheduledTransaction(ctx, {
  sourceIdentifier: "user_123",
  destinationIdentifier: "landlord_456",
  amount: 1500_00,
  currency: "USD",
  scheduledFor: "2026-03-01T00:00:00Z",
  reference: "rent-recurring",
  recurrence: {
    intervalMs: 30 * 24 * 60 * 60 * 1000, // ~30 days
    maxExecutions: 12,
  },
});
```

### Identifier Routing

The worker routes transactions based on identifier prefixes:

| Source | Destination | Operation |
|--------|------------|-----------|
| `@World` (system) | `user_123` (user) | `creditAccount` |
| `user_123` (user) | `@Fees` (system) | `debitAccount` |
| `user_123` (user) | `landlord_456` (user) | `transfer` |

System accounts are prefixed with `@`. Everything else is treated as a holder ID.

## Querying

```ts
import { getScheduledTransaction, listScheduledTransactions } from "@summa-ledger/summa/plugins";

// Get by ID
const tx = await getScheduledTransaction(ctx, scheduled.id);

// List all scheduled (pending) transactions
const pending = await listScheduledTransactions(ctx, {
  status: "scheduled",
  limit: 20,
});

// Filter by source
const userTxns = await listScheduledTransactions(ctx, {
  sourceIdentifier: "user_123",
});
```

Or via the HTTP API:

```bash
# Get by ID
curl http://localhost:3000/api/ledger/scheduled-transactions/:id

# List with filters
curl "http://localhost:3000/api/ledger/scheduled-transactions?status=scheduled&limit=20"
```

## Cancelling

Only transactions in `scheduled` status can be cancelled:

```ts
import { cancelScheduledTransaction } from "@summa-ledger/summa/plugins";

const cancelled = await cancelScheduledTransaction(ctx, scheduled.id, "No longer needed");
console.log(cancelled.status); // "cancelled"
```

Or via the HTTP API:

```bash
curl -X POST http://localhost:3000/api/ledger/scheduled-transactions/:id/cancel \
  -H "Content-Type: application/json" \
  -d '{ "reason": "No longer needed" }'
```

## How It Works

1. `createScheduledTransaction()` inserts a row into `scheduled_transaction` and initializes its status in `entity_status_log`
2. A background worker (`scheduled-processor`, interval: `1m`, lease-protected) polls for transactions whose `next_execution_at` has passed and status is `scheduled`
3. Each transaction goes through a **3-phase process**: lock + mark processing → execute financial operation → mark completed/rescheduled
4. Status transitions are tracked via `entity_status_log` (append-only)
5. Failed transactions are retried up to `maxRetries` times, then permanently marked as `failed`
6. Recurring transactions compute the next execution date and transition back to `scheduled`

## Events

The plugin emits events to the [event log](/docs/events) when transactions are processed:

| Event | When |
|-------|------|
| `ScheduledTransactionCreated` | A new scheduled transaction is created |
| `ScheduledTransactionProcessing` | Execution has started (row locked) |
| `ScheduledTransactionCompleted` | Execution succeeded (one-time or final recurring) |
| `ScheduledTransactionRescheduled` | Recurring transaction rescheduled for next execution |
| `ScheduledTransactionFailed` | All retry attempts exhausted — permanently failed |
| `ScheduledTransactionCancelled` | Manually cancelled |

## Background Workers

| Worker | Interval | Lease | Description |
|--------|----------|:-----:|-------------|
| `scheduled-processor` | 1m | Yes | Executes due scheduled transactions in batches |

## API Endpoints

| Method | Path | Description |
|--------|------|-------------|
| `POST` | `/scheduled-transactions` | Create a scheduled transaction |
| `GET` | `/scheduled-transactions/:id` | Get a scheduled transaction by ID |
| `GET` | `/scheduled-transactions` | List scheduled transactions (with filters) |
| `POST` | `/scheduled-transactions/:id/cancel` | Cancel a scheduled transaction |

## Type Inference

```ts
type ScheduledTx = typeof summa.$Infer.ScheduledTransaction;
// { id, reference, amount, currency, sourceIdentifier, destinationIdentifier,
//   scheduledFor, recurrence, status, executionCount, retryCount,
//   lastExecutedAt, nextExecutionAt, createdAt }
```

## Use Cases

- **Rent payments** — schedule monthly transfers
- **Subscription billing** — schedule recurring charges
- **Payroll** — schedule salary disbursements
- **Loan repayments** — schedule installment payments
