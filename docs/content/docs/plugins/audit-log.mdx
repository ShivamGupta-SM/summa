---
title: Audit Log
description: Immutable audit trail for all ledger operations.
icon: ClipboardDocumentList
---

## Overview

The audit log plugin records every account creation, transaction, hold, and administrative action into a dedicated `audit_log` table. Every mutation is tracked with who did it, what happened, and when.

## Setup

```ts
import { createSumma } from "@summa-ledger/summa";
import { auditLog } from "@summa-ledger/summa/plugins";

const summa = createSumma({
  database: adapter,
  currency: "USD",
  plugins: [auditLog()],
});
```

## Configuration

```ts
auditLog({
  operations: ["transaction.credit", "account.freeze"],  // Filter specific operations
  retentionDays: 365,       // How long to keep audit entries (default: 365)
  cleanupInterval: "1d",    // How often to purge old entries (default: "1d")
})
```

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `operations` | `string[]` | All operations | Filter to specific operation types |
| `retentionDays` | `number` | `365` | Days to retain audit log entries |
| `cleanupInterval` | `string` | `"1d"` | Background cleanup worker interval |

## How It Works

The plugin uses **operation hooks** (`operationHooks.after`) to intercept all ledger mutations. Every mutation is recorded with:

- **operation** — what happened (e.g., `transaction.credit`, `account.freeze`, `hold.commit`)
- **params** — the operation parameters (serialized as JSON)
- **actor** — who performed the action (extracted from `x-actor-id` request header, or `null` for programmatic SDK calls)
- **entryHash** — HMAC-SHA256 hash of the entry for integrity verification
- **timestamp** — when the action occurred

### Integrity Verification

Each audit log entry includes an `entryHash` — an HMAC-SHA256 hash computed from the operation type, parameters, and actor. When `advanced.hmacSecret` is configured, this hash uses the HMAC secret, making it impossible to forge entries without the key.

When querying audit logs via `queryAuditLog()`, Summa automatically verifies each entry's hash. If a mismatch is detected (indicating the entry was tampered with in the database), a warning is logged — but the entry is still returned. Audit reads never throw on integrity violations to avoid disrupting observability.

### Actor Tracking

When using the HTTP API, the `x-actor-id` header is automatically captured and stored in the audit log:

```bash
curl -X POST http://localhost:3000/api/ledger/transactions/credit \
  -H "Content-Type: application/json" \
  -H "x-actor-id: admin@example.com" \
  -d '{ "holderId": "user_123", "amount": 10000, "reference": "deposit-001" }'
```

The actor identity flows through Summa's `RequestContext` and is available to all operation hooks, not just the audit log.

For programmatic SDK usage (not via HTTP), `actor` will be `null` unless you manually set `requestContext` on the context object.

## Querying Audit Logs

Use the standalone `queryAuditLog` function to search the audit trail:

```ts
import { queryAuditLog } from "@summa-ledger/summa/plugins";

const logs = await queryAuditLog(summa.$context, {
  operation: "transaction.credit",  // Filter by operation type
  actor: "admin@example.com",       // Filter by actor
  since: new Date("2025-01-01"),    // Start date
  until: new Date("2025-02-01"),    // End date
  limit: 50,                        // Default: 50
  offset: 0,                        // Pagination offset
});

for (const entry of logs) {
  console.log(entry.id);         // Unique entry ID
  console.log(entry.operation);  // "transaction.credit"
  console.log(entry.params);     // { holderId: "user_123", amount: 10000, ... }
  console.log(entry.actor);      // "admin@example.com" or null
  console.log(entry.timestamp);  // "2025-01-15T10:30:00Z"
}
```

### Query Parameters

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `operation` | `string` | — | Filter by operation type |
| `actor` | `string` | — | Filter by actor identifier |
| `since` | `Date` | — | Entries after this date |
| `until` | `Date` | — | Entries before this date |
| `limit` | `number` | `50` | Max entries to return |
| `offset` | `number` | `0` | Pagination offset |

## Type Inference

```ts
import type { AuditLogEntry } from "@summa-ledger/summa/plugins";

type AuditEntry = typeof summa.$Infer.AuditLogEntry;
// { id, operation, params, actor, entryHash, timestamp }
```

## Tracked Operations

| Operation | Trigger |
|-----------|---------|
| `account.create` | Account created |
| `account.freeze` | Account frozen |
| `account.unfreeze` | Account unfrozen |
| `account.close` | Account closed |
| `transaction.credit` | Funds credited |
| `transaction.debit` | Funds debited |
| `transaction.transfer` | Funds transferred |
| `transaction.refund` | Transaction refunded |
| `hold.create` | Hold created |
| `hold.commit` | Hold committed |
| `hold.void` | Hold voided |
| `transaction.correct` | Transaction corrected |
| `transaction.adjust` | Adjustment entry posted |
| `transaction.journal` | Journal entry posted |
